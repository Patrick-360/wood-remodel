import{A as R,b as rr,C as Q}from"./B4NmBDdK.js";import{W as V,Y as j,k as er,ai as $,ah as L,X as Y,w as X,aj as N,aa as A,u as Z,P as tr,H as ir,R as nr,S as ar,Q as sr,T as or}from"./DtJjbnup.js";import{F as ur}from"./B9-UTvb5.js";import{f as G}from"./D2HUyf-o.js";import{C as m,s as K,$ as lr}from"./BeDKUvii.js";const vr={base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}},br=(r,e,t)=>{let s=[];return{updatedProducts:r.map(i=>{if(i._id===t._id){if(e>i.max)return i.qty=i.qty,s.push(`A maximum of ${i.max} units of ${i.name} only can be purchased`),i;if(e>i.price.availableQuantity&&i.price.trackInventory&&!i.price.allowOutOfStockPurchases)return i.qty=i.qty,s.push(`Only ${i.price.availableQuantity} units of ${i.name} are in stock`),i;i.qty=e}return i}),errorMessages:s}},_r=r=>{var e,t,s;return((e=r==null?void 0:r.price)==null?void 0:e.availableQuantity)<=0&&((t=r==null?void 0:r.price)==null?void 0:t.trackInventory)&&!((s=r==null?void 0:r.price)!=null&&s.allowOutOfStockPurchases)},Er=(r,e)=>e.find(t=>t._id===r.id),dr=async({contactId:r,domain:e,pageUrl:t,locationId:s,productPreviewList:u,isCouponApplied:i,couponCode:n,couponSessionId:a,store:f,subType:c,traceId:S="",reCaptchaToken:o,isEcommercePurchase:I,shippingRateId:d,toZip:w,toState:O,toCountry:P,shippingCarrierRateId:F,note:k,separateBillingAddress:C})=>{var v,b,_,g;try{const h=m("msgsndr_id").value,U=m("am_id").value,x=m("am_fingerprint").value,M=f.funnelName||"funnel";e||(e=window.location.hostname,t=window.location.pathname);const{funnelPageId:q,funnelId:z,stepId:W}=f,T={altId:s,altType:"location",shippingRateId:d,shippingCarrierRateId:F,contactId:r,source:{type:f.pageType===N.FUNNEL?N.FUNNEL:N.WEBSITE,subType:c,id:z,name:M,meta:{stepId:W,pageId:q,domain:e,pageUrl:t,affiliateManager:{id:U,fingerprint:x}}},products:u.map(E=>({id:I?E.selectedPrice._id:E._id,qty:E.qty||E.quantity})),fingerprint:h,trackingId:$(),traceId:S,toZip:w,toState:O,toCountry:P,customerNote:k,separateBillingAddress:C};i&&(T.couponCode=n,T.couponSessionId=a),o&&(T.captchaToken=o);const y=await A.createOrder(T);if(!((v=y.order)==null?void 0:v._id))throw new Error("Something went wrong while creating order. Please try again later.");return y}catch(h){return console.error(h),{error:!0,message:(_=(b=h==null?void 0:h.response)==null?void 0:b._data)==null?void 0:_.message,status:(g=h==null?void 0:h.response)==null?void 0:g.status}}},gr=async(r,e,t,s,u,i,n)=>{var J,E,B;const a=m("msgsndr_id").value,f=m("am_id").value,c=m("am_fingerprint").value,S=tr(r.locationId),o=ir(r.locationId),I=nr(),d=r.funnelName||"funnel";let{domain:w,page_url:O}=e.query;w||(w=window.location.hostname,O=window.location.pathname);const{funnelPageId:P,funnelId:F,stepId:k}=r,C={eventType:"optin",domainName:w,pageUrl:O,funnelId:F,pageId:P,stepId:k},{address:v,country:b,state:_,city:g,zipcode:h,fullName:U,phoneNumber:x,emailId:M,companyName:q}=t,z={addressLine1:v,country:b||s,state:_,city:g,zip:h};I.medium=ar.OrderForm,I.mediumId=C.stepId;const W=sr();I.fbEventId=W;const T={lead:!0,eventData:I,source:d,pageId:P,funnelId:F,sessionId:S,funnelEventData:C,sessionFingerprint:o||null},y={locationId:r.locationId,name:U,phone:x,email:(M==null?void 0:M.toLowerCase())||"",companyName:q,address:z,attribution:T,timezone:or(),amId:String(f),amFingerprint:c,orderFormType:"one_step_form_submission",captchaToken:u,billingAddress:n};i.enableStickyContact&&(y.attribution.fingerprint=a,y.attribution.funnelEventData.fingerprint=a),i.enableForceCreate&&(y.attribution.forceCreate=!0),i.enableEmailValidation&&(y.attribution.session_d=Number(i.enableEmailValidation)||0);try{const l=await ur.createContact(y);if(!l)throw new Error("Something went wrong. Please try again later.");if(l.fbEventId=W,a!==l.fingerprint){r.fingerprint=a;const D=m("msgsndr_id",{path:"/",maxAge:31536e3});D.value=l.fingerprint}$();const p=Y(l);X("_ud",p),K(()=>{G("track","SubmitApplication")});let H=l.sessionFingerprint;return I&&(V({sessionId:l.sessionId||null,locationId:r.locationId}),H&&j(r.locationId,H)),l}catch(l){return console.error(l),{error:!0,message:(E=(J=l==null?void 0:l.response)==null?void 0:J._data)==null?void 0:E.message,status:(B=l==null?void 0:l.response)==null?void 0:B.status}}},Or=async(r,e,t,s,u,i,n,a,f,c,S,o,I,d,w,O,P,F,k,C)=>{var v,b,_;if((!n||!n.id)&&(n=await gr(r,e,t,s,u,i,F),u=void 0),n!=null&&n.error){let g={};return(n==null?void 0:n.status)===429?(g={error:!0,processingPayment:!1,showRecaptcha:!0},g):(g={error:!0,processingPayment:!1,cardErrorMsg:n.message||"We're sorry, but something went wrong. Please try again"},g)}if((n.id&&!a||!((v=a==null?void 0:a.order)!=null&&v._id))&&(a=await dr({contactId:n==null?void 0:n.id,domain:r.domain,pageUrl:r.pageUrl,locationId:r.locationId,productPreviewList:c,isCouponApplied:f,couponCode:o,couponSessionId:S,store:r,subType:d,traceId:n==null?void 0:n.traceId,reCaptchaToken:u,isEcommercePurchase:I,shippingRateId:w,toZip:(t==null?void 0:t.zipcode)??((b=t.address)==null?void 0:b.zip),toState:O,toCountry:(t==null?void 0:t.country)??((_=t.address)==null?void 0:_.country),shippingCarrierRateId:P,note:k,separateBillingAddress:C}),u=void 0),a!=null&&a.error){let g={};return a.status===429?(g={error:!0,processingPayment:!1,showRecaptcha:!0,contactResponse:n},g):(g={error:!0,processingPayment:!1,contactResponse:n,cardErrorMsg:a.message||"We're sorry, but something went wrong. Please try again"},g)}return(a==null?void 0:a.success)===!1?{error:!0,cardErrorMsg:a==null?void 0:a.message,processingPayment:!1}:(sessionStorage.setItem("orderResponse",JSON.stringify(a)),d!=L.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(n)),sessionStorage.setItem("orderResponse",JSON.stringify(a)),d!=L.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(n)),sessionStorage.setItem("orderResponse",JSON.stringify(a)),d!=L.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(n)),{contactResponse:n,orderResponse:a,reCaptchaToken:u})},mr=(r,e,t,s)=>{if($()!=(t==null?void 0:t.verifiedTrackingId)){const i=m("tr",{path:"/",maxAge:900});i.value=t==null?void 0:t.verifiedTrackingId}if(s!==L.TWO_STEP_ORDER_FORM){if(r.fingerprint!==e){const n=m("msgsndr_id",{path:"/",maxAge:31536e3});n.value=r.fingerprint}const i=Y(r);X("_ud",i)}if(r.fbEventId){let i=r.fbEventId;K(()=>{G("track","OrderFormPurchase",i)})}else console.warn("Facebook event Id missing from attribution!")},Pr=async(r,e,t,s,u)=>{let i=!1,n="";if(e!=null&&e.message&&!(e!=null&&e.success))throw new Error(e.message);t===R&&(e!=null&&e.pendingConfirmation)&&(i=!0,n="Order placed successfully! However your transaction is pending for review. Please contact the business owner");const a=m("msgsndr_id").value;await mr(r,a,e,u);const f=m("provider");f.value=t===rr?"pp":t===Q?Q:"cc",await fr({sessionId:r.sessionId,sessionFingerprint:e==null?void 0:e.sessionFingerprint},s);const c=sessionStorage.getItem("redirect");if(cr(s),c){sessionStorage.removeItem("redirect"),window.location.href=c;return}return{paymentResponseData:e,authorizeOrderPendingConfirmation:i,authorizeOrderAlertMsg:n}},fr=(r,e)=>{r&&r.sessionId&&(V({sessionId:r.sessionId||null,locationId:e}),r.sessionFingerprint&&j(e,r.sessionFingerprint))},Fr=r=>{var t;(!(r.keyCode>=48&&r.keyCode<=57||r.keyCode>=96&&r.keyCode<=105)||!/^\d{0,2}$/.test((t=r.target)==null?void 0:t.value))&&r.keyCode!==8&&r.preventDefault()},cr=r=>{const e=er();return sessionStorage.setItem(`couponSessionId_${r}`,e),e},Cr=async(r,e,t="",s,u,i)=>{var n,a,f,c,S;try{const o=Z(),I={altId:o.value.locationId,altType:"location",couponCode:t,source:{type:o.value.pageType===N.FUNNEL?N.FUNNEL:N.WEBSITE,subType:e,id:o.value.funnelId,name:o.value.funnelName,meta:{stepId:o.value.stepId,pageId:o.value.funnelPageId,domain:o.value.domain,pageUrl:o.value.pageUrl,affiliateManager:{id:m("am_id").value,fingerprint:m("msgsndr_id").value}}},products:r,toCountry:s,toState:u,toZip:i},d=await A.getAmountSummary(I);return{total:d.summary.total,subtotal:d.summary.subtotal,taxSummary:d.summary.taxSummary,subtotalWithDiscount:d.summary.subtotalWithDiscount,futureRecurringPaymentAmount:(n=d.recurringSummary)==null?void 0:n.subtotalWithDiscount}}catch(o){return console.error(o),{error:!0,message:((f=(a=o==null?void 0:o.response)==null?void 0:a._data)==null?void 0:f.message)||"Something went wrong while fetching order total. Please try again later",status:(S=(c=o==null?void 0:o.response)==null?void 0:c._data)==null?void 0:S.status}}},Tr=async(r,e)=>{const t=await A.getLastPaymentMethodForTheCustomer({altId:r,altType:"location",contactId:e});return{paymentProvider:t==null?void 0:t.paymentProvider,paymentMethod:t==null?void 0:t.paymentMethod}},Nr=async(r,e)=>await A.getLastSquarePaymentMethodForTheCustomer({altId:r,altType:"location",contactId:e}),kr=(r,e,t,s)=>{const u=e<=0&&!t,i=t&&s<=0,n=u||i;return!!(r&&n||n)},Mr=async()=>{const r=Z();try{const e=await A.getStatesInformation();if(e&&e.error)throw lr(e.error);r.value.countryList=(e==null?void 0:e.data)??[]}catch(e){console.error("Failed to fetch country list",e)}},Ar=r=>Z().value.countryList.find(t=>t.code===r),Wr=(r,e,t)=>{if(r.startsWith("+44")&&e.match(/^07\d*$/)){const s=r.replace("+44 1534","+44").replace("1534","");return window.libphonenumber.parsePhoneNumberFromString(s,"JE").formatInternational()}return t.formatInternational()};export{Cr as a,Mr as b,dr as c,Nr as d,Wr as e,Tr as f,Ar as g,Pr as h,cr as i,_r as j,Er as k,br as l,Or as m,Fr as n,kr as p,vr as s};
